<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản lý Lớp học | TutorUber</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

    <style>
      /* --- GLOBAL STYLES --- */
      body { 
          font-family: "Poppins", sans-serif; 
          background: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%); 
          min-height: 100vh; 
          padding: 40px 20px; 
          color: #2d3748; 
      }
      .main-card { 
          background: rgba(255, 255, 255, 0.95); 
          backdrop-filter: blur(10px); 
          border-radius: 24px; 
          box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2); 
          border: none; 
          max-width: 1200px; 
          margin: 0 auto; 
          overflow: hidden; 
      }
      
      /* --- HEADER --- */
      .card-header-custom { 
          padding: 30px 40px; 
          background: white; 
          border-bottom: 1px solid #edf2f7; 
          display: flex; 
          justify-content: space-between; 
          align-items: center; 
          flex-wrap: wrap; 
          gap: 15px; 
      }
      .header-title { 
          background: linear-gradient(to right, #ff512f, #dd2476); 
          -webkit-background-clip: text; 
          -webkit-text-fill-color: transparent; 
          font-weight: 700; 
          font-size: 1.8rem; 
          margin: 0; 
      }

      /* --- BUTTONS --- */
      .btn-create { 
          background: linear-gradient(45deg, #ff512f 0%, #dd2476 100%); 
          border: none; 
          color: white; 
          padding: 12px 30px; 
          border-radius: 50px; 
          font-weight: 600; 
          box-shadow: 0 5px 15px rgba(221, 36, 118, 0.3); 
          transition: 0.3s; 
      }
      .btn-create:hover { 
          transform: translateY(-3px); 
          box-shadow: 0 8px 25px rgba(221, 36, 118, 0.5); 
          color: white; 
      }
      .btn-requests { 
          background: white; 
          color: #ff512f; 
          border: 2px solid #ff512f; 
          padding: 10px 25px; 
          border-radius: 50px; 
          font-weight: 600; 
          transition: 0.3s; 
          position: relative; 
      }
      .btn-requests:hover { 
          background: #fff5f5; 
          transform: translateY(-2px); 
      }
      /* Style cho nút đăng xuất */
      .btn-logout {
          background: #f7fafc;
          color: #718096;
          border: 1px solid #e2e8f0;
          padding: 10px 20px;
          border-radius: 50px;
          font-weight: 600;
          transition: 0.3s;
      }
      .btn-logout:hover {
          background: #e2e8f0;
          color: #2d3748;
      }

      .notification-badge { 
          position: absolute; 
          top: -8px; 
          right: -8px; 
          background: #dc3545; 
          color: white; 
          border-radius: 50%; 
          width: 24px; 
          height: 24px; 
          font-size: 0.75rem; 
          display: none; 
          align-items: center; 
          justify-content: center; 
          border: 2px solid white; 
          font-weight: bold; 
      }

      /* --- TABLE STYLES --- */
      .table-responsive { padding: 0 20px 20px 20px; }
      .table-custom { border-collapse: separate; border-spacing: 0 10px; }
      .table-custom thead th { 
          border: none; 
          font-weight: 600; 
          color: #64748b; 
          text-transform: uppercase;
          font-size: 0.75rem;
          letter-spacing: 0.5px; 
          padding: 15px 10px;
          background: transparent !important;
      }
      .table-custom tbody tr { 
          background: white; 
          box-shadow: 0 5px 10px rgba(0,0,0,0.02); 
          border-radius: 12px; 
          transition: transform 0.2s, box-shadow 0.2s; 
          cursor: pointer;
      }
      .table-custom tbody tr td { border: none; padding: 15px 10px; vertical-align: middle; }
      .table-custom tbody tr td:first-child { border-top-left-radius: 12px; border-bottom-left-radius: 12px; padding-left: 20px; }
      .table-custom tbody tr td:last-child { border-top-right-radius: 12px; border-bottom-right-radius: 12px; padding-right: 20px; }
      
      .table-custom tbody tr:hover { 
          transform: translateY(-3px); 
          box-shadow: 0 8px 20px rgba(0,0,0,0.08); 
          background-color: #fffafa !important; 
      }

      /* --- TABLE COMPONENTS --- */
      .subject-icon { 
          width: 45px; 
          height: 45px; 
          background: #fff0f0; 
          color: #ff512f; 
          display: flex; 
          align-items: center; 
          justify-content: center; 
          border-radius: 12px; 
          font-size: 1.2rem; 
          margin-right: 15px; 
          flex-shrink: 0;
      }
      .schedule-badge { 
          background: #edf2f7; 
          color: #4a5568; 
          padding: 4px 10px; 
          border-radius: 6px; 
          font-size: 0.75rem; 
          display: inline-block; 
          font-weight: 500; 
          margin-bottom: 4px;
      }
      .price-text { color: #dd2476; font-weight: 700; font-size: 1rem; }
      .progress-thin { height: 6px; border-radius: 10px; background-color: #edf2f7; margin-top: 8px; }
      .text-location { font-size: 0.8rem; color: #718096; display: flex; align-items: center; gap: 5px; }

      /* --- MODAL --- */
      .schedule-row { 
          background: white; 
          border: 1px dashed #cbd5e0; 
          border-radius: 12px; 
          padding: 10px; 
          margin-bottom: 10px; 
          display: flex; 
          gap: 10px; 
          align-items: center; 
      }
      .btn-remove-row { width: 35px; height: 35px; border-radius: 50%; background: #fee2e2; color: #e53e3e; border: none; }
    </style>
  </head>
  <body>
    <div class="main-card">
      <div class="card-header-custom">
        <div>
          <h2 class="header-title"><i class="fa-solid fa-chalkboard-user me-2"></i>Quản lý Lớp học</h2>
          <p class="text-muted mb-0 small mt-1">Xin chào, <strong><span id="displayTutorName">Gia sư</span> (ID: <span id="displayId">...</span>)</strong></p>
        </div>
        <div class="d-flex gap-3">
          <button class="btn-requests" onclick="openPendingRequestsModal()">
            <i class="fa-solid fa-bell me-2"></i>Yêu cầu
            <span id="badgeCount" class="notification-badge">0</span>
          </button>
          <button class="btn-create" onclick="openCreateModal()">
            <i class="fa-solid fa-plus me-2"></i>Tạo Lớp Mới
          </button>
          <button class="btn-logout" onclick="logout()" title="Đăng xuất">
             <i class="fa-solid fa-right-from-bracket"></i>
          </button>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-custom mb-0">
          <thead>
            <tr>
              <th width="5%">ID</th>
              <th width="30%">Thông tin lớp học</th>
              <th width="25%">Lịch & Địa điểm</th>
              <th width="15%">Học phí/tháng</th>
              <th width="20%">Trạng thái sĩ số</th>
              <th width="5%" class="text-center"><i class="fa-solid fa-chevron-right"></i></th>
            </tr>
          </thead>
          <tbody id="classTableBody">
            <tr><td colspan="6" class="text-center py-5 text-muted">Đang tải dữ liệu... <i class="fa-solid fa-spinner fa-spin"></i></td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="modal fade" id="pendingModal" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
          <div class="modal-header text-white bg-warning">
            <h5 class="modal-title fw-bold text-dark"><i class="fa-solid fa-user-clock me-2"></i>Danh Sách Chờ Duyệt</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0 align-middle">
                <thead class="bg-light text-secondary small text-uppercase">
                   <tr>
                       <th class="ps-4 py-3">Học viên</th>
                       <th>Lớp đăng ký</th>
                       <th>Ngày Đăng Ký</th>
                       <th class="text-center">Hành động</th>
                   </tr>
                </thead>
                <tbody id="pendingTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="createClassModal" tabindex="-1" data-bs-backdrop="static">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0">
          <div class="modal-header">
            <h5 class="modal-title fw-bold">Mở Lớp Học Mới</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body p-4 bg-light">
            <form id="createClassForm">
                <div class="row g-3 mb-4">
                    <div class="col-md-12">
                        <label class="form-label">Tên môn học *</label>
                        <input type="text" id="inpSubject" class="form-control" placeholder="Ví dụ: Toán lớp 12 - Luyện thi ĐH" required />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Học phí (VNĐ) *</label>
                        <input type="number" id="inpFee" class="form-control" placeholder="500000" required />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Sĩ số tối đa *</label>
                        <input type="number" id="inpMax" class="form-control" value="10" required />
                    </div>
                    <div class="col-md-12">
                        <label class="form-label">Địa điểm</label>
                        <input type="text" id="inpLocation" class="form-control" placeholder="Online qua Zoom hoặc Địa chỉ nhà..." />
                    </div>
                    <div class="col-md-12">
                        <label class="form-label">Mô tả chi tiết</label>
                        <textarea id="inpDesc" class="form-control" rows="2" placeholder="Nội dung khóa học, yêu cầu..."></textarea>
                    </div>
                </div>
                <div class="mb-2">
                    <label class="form-label fw-bold">Lịch học</label>
                    <div id="scheduleContainer"></div>
                    <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addScheduleRow()">+ Thêm lịch</button>
                </div>
            </form>
          </div>
          <div class="modal-footer border-0 bg-light">
            <button type="button" class="btn-create px-5" onclick="submitCreateClass()">Đăng Lớp</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      const API_BASE_URL = "http://localhost:8080/api"; 
      
      // --- BIẾN TOÀN CỤC CHO AUTH ---
      let CURRENT_TUTOR_ID = null;
      let AUTH_TOKEN = null;

      // Hàm kiểm tra đăng nhập (Chạy đầu tiên)
      function checkAuth() {
          const token = localStorage.getItem("token");
          const userStr = localStorage.getItem("user");
          const role = localStorage.getItem("role");

          // Nếu thiếu thông tin hoặc sai quyền Tutor -> Đá về Login
          if (!token || !userStr || role !== "TUTOR") {
              alert("Phiên đăng nhập hết hạn hoặc không hợp lệ. Vui lòng đăng nhập lại.");
              window.location.href = "login.html";
              return false;
          }

          const user = JSON.parse(userStr);
          CURRENT_TUTOR_ID = user.id;
          AUTH_TOKEN = token;

          // Hiển thị tên Tutor lên giao diện
          document.getElementById('displayId').innerText = CURRENT_TUTOR_ID;
          document.getElementById('displayTutorName').innerText = user.fullName || user.username || "Gia sư";
          return true;
      }

      // Hàm đăng xuất
      function logout() {
          localStorage.clear();
          window.location.href = "login.html";
      }

      // Hàm tạo Header chứa Token (Dùng cho mọi request Fetch)
      function getAuthHeaders() {
          return {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${AUTH_TOKEN}`
          };
      }

      let createModal, pendingModalInstance;

      document.addEventListener("DOMContentLoaded", () => {
        // Kiểm tra Auth trước, nếu OK mới chạy tiếp
        if (!checkAuth()) return;

        createModal = new bootstrap.Modal(document.getElementById("createClassModal"));
        pendingModalInstance = new bootstrap.Modal(document.getElementById("pendingModal"));
        
        loadClasses();
        checkPendingRequests(); 
        setInterval(checkPendingRequests, 10000); 
      });

      // --- 1. TẢI DANH SÁCH LỚP ---
      async function loadClasses() {
        const tbody = document.getElementById("classTableBody");
        try {
          // Thêm headers auth vào request
          const res = await fetch(`${API_BASE_URL}/classes/tutor/${CURRENT_TUTOR_ID}`, {
              headers: getAuthHeaders()
          });
          
          // Xử lý nếu Token hết hạn (401/403)
          if (res.status === 401 || res.status === 403) {
              logout();
              return;
          }

          const json = await res.json();
          const loadedClasses = json.data || [];

          tbody.innerHTML = "";
          if (!loadedClasses.length) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5 text-muted">Bạn chưa tạo lớp nào. Hãy nhấn nút "Tạo Lớp Mới".</td></tr>';
            return;
          }

          loadedClasses.forEach((c) => {
            let schedHtml = "";
            if(c.schedules && c.schedules.length > 0) {
                 schedHtml = c.schedules.map(s => 
                    `<div><span class="schedule-badge">${s.dayOfWeek}: ${formatTime(s.startTime)}-${formatTime(s.endTime)}</span></div>`
                ).join("");
            } else {
                schedHtml = "<small class='text-muted fst-italic'>Chưa cập nhật lịch</small>";
            }

            const current = c.currentStudents || 0;
            const max = c.maxStudents || 1;
            const percent = Math.min((current / max) * 100, 100);
            
            let progressClass = "bg-success";
            let statusBadge = `<span class="text-muted small fw-bold">${current} / ${max} HV</span>`;
            
            if (percent >= 100) {
                progressClass = "bg-danger";
                statusBadge = `<span class="badge bg-danger">Đã đầy</span>`;
            } else if (percent >= 70) {
                progressClass = "bg-warning";
            }

            const row = `
                <tr onclick="window.location.href='DetailClass.html?id=${c.id}'">
                    <td class="text-muted fw-bold">#${c.id}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="subject-icon"><i class="fa-solid fa-book-open"></i></div>
                            <div>
                                <div class="fw-bold text-dark">${c.subject}</div>
                                <div class="small text-muted text-truncate" style="max-width: 200px;">${c.description || "Không có mô tả"}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="d-flex flex-column gap-1">
                            ${schedHtml}
                            <div class="text-location mt-1">
                                <i class="fa-solid fa-location-dot text-danger"></i> 
                                ${c.location ? c.location : "Online"}
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="price-text">${formatCurrency(c.fee)}</div>
                    </td>
                    <td>
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            ${statusBadge}
                            <small class="text-muted">${Math.round(percent)}%</small>
                        </div>
                        <div class="progress progress-thin">
                            <div class="progress-bar ${progressClass}" role="progressbar" style="width: ${percent}%"></div>
                        </div>
                    </td>
                    <td class="text-center text-muted">
                        <i class="fa-solid fa-angle-right"></i>
                    </td>
                </tr>`; 
            tbody.innerHTML += row;
          });
        } catch (err) { 
            console.error(err);
            tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger py-4">Không thể kết nối Backend API</td></tr>`; 
        }
      }

      // --- 2. XỬ LÝ YÊU CẦU ---
      async function checkPendingRequests() {
        try {
            const res = await fetch(`${API_BASE_URL}/bookings/tutor/${CURRENT_TUTOR_ID}`, {
                headers: getAuthHeaders() // Thêm token
            });
            const json = await res.json();
            const pendingList = (json.data || []).filter(b => b.status === "PENDING");
            
            const badge = document.getElementById("badgeCount");
            if (pendingList.length > 0) {
                badge.style.display = "flex";
                badge.innerText = pendingList.length;
            } else {
                badge.style.display = "none";
            }
            return pendingList;
        } catch(e) { return []; }
      }

      async function openPendingRequestsModal() {
        const tbody = document.getElementById("pendingTableBody");
        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-5"><div class="spinner-border text-warning"></div></td></tr>';
        pendingModalInstance.show();

        const list = await checkPendingRequests();
        tbody.innerHTML = "";

        if(list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center py-5 text-muted">Hiện tại không có yêu cầu nào chờ duyệt.</td></tr>';
            return;
        }

        list.forEach(b => {
            const row = `
                <tr>
                    <td class="ps-4">
                        <div class="fw-bold">${b.studentName || "Học viên ẩn"}</div>
                        <div class="small text-muted">ID: ${b.studentId}</div>
                    </td>
                    <td>
                        <div class="fw-bold text-primary">${b.classSubject || "Lớp học"}</div>
                        <div class="small text-muted">Mã lớp: #${b.classId}</div>
                    </td>
                    <td>${new Date(b.bookedDate).toLocaleDateString('vi-VN')}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-success rounded-pill px-3 fw-bold shadow-sm" onclick="approveRequest(${b.id})">
                            <i class="fa-solid fa-check me-1"></i> Duyệt
                        </button>
                    </td>
                </tr>`;
            tbody.innerHTML += row;
        });
      }

      async function approveRequest(bookingId) {
         try {
             const res = await fetch(`${API_BASE_URL}/bookings/${bookingId}/confirm/tutor/${CURRENT_TUTOR_ID}`, { 
                 method: "PUT",
                 headers: getAuthHeaders() // Thêm token
             });
             const json = await res.json();

             if(json.success) {
                 Swal.fire({ icon: 'success', title: 'Đã duyệt!', showConfirmButton: false, timer: 1000 });
                 openPendingRequestsModal(); 
                 loadClasses(); 
             } else {
                 Swal.fire("Lỗi", json.message, "error");
             }
         } catch(e) { Swal.fire("Lỗi kết nối", "Không thể kết nối đến server", "error"); }
      }

      // --- 3. TẠO LỚP ---
      function openCreateModal() {
        document.getElementById("createClassForm").reset();
        document.getElementById("scheduleContainer").innerHTML = "";
        addScheduleRow(); 
        createModal.show();
      }

      function addScheduleRow() {
        const html = `
            <div class="schedule-row">
                <div class="flex-grow-1 row g-2">
                    <div class="col-4">
                        <select class="form-select form-select-sm inp-day">
                            <option value="MONDAY">Thứ 2</option>
                            <option value="TUESDAY">Thứ 3</option>
                            <option value="WEDNESDAY">Thứ 4</option>
                            <option value="THURSDAY">Thứ 5</option>
                            <option value="FRIDAY">Thứ 6</option>
                            <option value="SATURDAY">Thứ 7</option>
                            <option value="SUNDAY">CN</option>
                        </select>
                    </div>
                    <div class="col-4"><input type="time" class="form-control form-control-sm inp-start" required></div>
                    <div class="col-4"><input type="time" class="form-control form-control-sm inp-end" required></div>
                </div>
                <button type="button" class="btn-remove-row" onclick="this.parentElement.remove()"><i class="fa-solid fa-xmark"></i></button>
            </div>`;
        document.getElementById("scheduleContainer").insertAdjacentHTML("beforeend", html);
      }

      async function submitCreateClass() {
        const subject = document.getElementById("inpSubject").value;
        const fee = document.getElementById("inpFee").value;
        const max = document.getElementById("inpMax").value;
        const loc = document.getElementById("inpLocation").value;
        const desc = document.getElementById("inpDesc").value;
        
        const schedules = [];
        document.querySelectorAll("#scheduleContainer .schedule-row").forEach(r => {
             const day = r.querySelector(".inp-day").value;
             const start = r.querySelector(".inp-start").value;
             const end = r.querySelector(".inp-end").value;
             if(day && start && end) {
                 schedules.push({ dayOfWeek: day, startTime: start, endTime: end });
             }
        });

        if (!subject || !fee || !max) { 
            Swal.fire("Thiếu thông tin", "Vui lòng nhập tên môn, học phí và sĩ số.", "warning"); return; 
        }
        
        try {
            const res = await fetch(`${API_BASE_URL}/classes/tutor/${CURRENT_TUTOR_ID}`, {
                method: "POST",
                headers: getAuthHeaders(), // Thêm token
                body: JSON.stringify({ 
                    subject, description: desc, fee: parseFloat(fee), 
                    maxStudents: parseInt(max), location: loc, schedules 
                }),
            });
            const json = await res.json();
            
            if(json.success) {
                createModal.hide();
                loadClasses();
                Swal.fire("Thành công", "Đã mở lớp học mới!", "success");
            } else {
                Swal.fire("Lỗi Server", json.message, "error");
            }
        } catch(e) { Swal.fire("Lỗi", "Không kết nối được server", "error"); }
      }

      // --- UTILS ---
      function formatCurrency(val) {
          return new Intl.NumberFormat("vi-VN", { style: 'currency', currency: 'VND' }).format(val);
      }
      function formatTime(timeStr) {
          if(!timeStr) return "";
          if (Array.isArray(timeStr)) {
              return timeStr[0].toString().padStart(2, '0') + ':' + timeStr[1].toString().padStart(2, '0');
          }
          return timeStr.substring(0, 5);
      }
    </script>
  </body>
</html>