<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi Tiết Lớp Học</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: "Poppins", sans-serif; background: #f0f2f5; min-height: 100vh; padding: 40px 0; }
        .detail-card { background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); overflow: hidden; border: none; }
        .detail-header { background: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%); padding: 40px; color: white; position: relative; }
        .back-btn { position: absolute; top: 15px; left: 15px; background: rgba(255, 255, 255, 0.2); border: none; border-radius: 50%; width: 40px; height: 40px; line-height: 40px; text-align: center; color: white; transition: background 0.3s; }
        .back-btn:hover { background: rgba(255, 255, 255, 0.4); }
        .schedule-tag { background: #e0f7fa; color: #00bcd4; padding: 5px 10px; border-radius: 15px; margin-right: 8px; margin-bottom: 8px; font-size: 0.85rem; display: inline-block; font-weight: 500;}
        .student-table-container { margin-top: 30px; }
        .table-responsive { border-radius: 15px; overflow: hidden; }
        .table thead th { background-color: #f7f7f7; color: #333; font-weight: 600; border-bottom: 2px solid #ddd; }
        
        .clickable-row { cursor: pointer; transition: background-color 0.2s; }
        .clickable-row:hover { background-color: #f1f3f5; }
    </style>
</head>
<body>

<div class="container my-5">
    <button class="back-btn" onclick="window.location.href='HomeTutor.html'"><i class="fas fa-arrow-left"></i></button>
    
    <div class="detail-card">
        <div class="detail-header">
            <h1 class="display-5 fw-bold" id="classSubject">Đang tải chi tiết lớp học...</h1>
            <p class="lead" id="classTutorName">Gia sư: ...</p>
            <div class="d-flex gap-3 mt-3">
                <span id="classStatus" class="badge bg-light text-dark py-2 px-3 fw-normal">...</span>
                <span id="classFee" class="badge bg-light text-dark py-2 px-3 fw-normal">...</span>
            </div>
            <button class="btn btn-light btn-sm mt-3" data-bs-toggle="modal" data-bs-target="#editModal"><i class="fas fa-edit me-2"></i> Chỉnh Sửa</button>
            <button class="btn btn-outline-light btn-sm mt-3 ms-2" onclick="deleteClass()"><i class="fas fa-trash-alt me-2"></i> Xóa Lớp</button>
        </div>

        <div class="p-4 p-md-5">
            <h4 class="text-primary mb-3"><i class="fas fa-info-circle me-2"></i> Thông tin chi tiết</h4>
            <div class="row mb-4">
                <div class="col-md-6">
                    <p><strong>Mô tả:</strong> <span id="classDescription"></span></p>
                    <p><strong>Địa điểm:</strong> <span id="classLocation"></span></p>
                </div>
                <div class="col-md-6">
                    <p><strong>Số lượng:</strong> <span id="classCurrentStudents">0</span> / <span id="classMaxStudents">0</span> học viên</p>
                    <p><strong>Ngày tạo:</strong> <span id="classCreatedAt"></span></p>
                </div>
            </div>

            <h4 class="text-primary mb-3"><i class="fas fa-calendar-alt me-2"></i> Lịch học</h4>
            <div id="scheduleList" class="d-flex flex-wrap mb-4"></div>

            <div class="student-table-container">
                <h4 class="text-primary mb-3"><i class="fas fa-users me-2"></i> Danh sách Học viên đăng ký</h4>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>ID HV</th>
                                <th>Tên Học viên</th>
                                <th>Ngày đăng ký</th>
                                <th>Trạng thái</th>
                            </tr>
                        </thead>
                        <tbody id="studentListBody">
                            <tr><td colspan="4" class="text-center text-muted">Đang tải danh sách...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="fas fa-edit me-2"></i> Chỉnh Sửa Lớp Học</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editClassId">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Môn học</label>
                        <input type="text" class="form-control" id="editSubject" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Học phí (VND)</label>
                        <input type="number" class="form-control" id="editFee" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Số lượng học viên tối đa</label>
                        <input type="number" class="form-control" id="editMax" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Địa điểm</label>
                        <input type="text" class="form-control" id="editLocation" required>
                    </div>
                    <div class="col-12 mb-3">
                        <label class="form-label">Mô tả chi tiết</label>
                        <textarea class="form-control" id="editDesc" rows="3"></textarea>
                    </div>
                </div>
                
                <h5 class="mt-4 text-warning">Chỉnh sửa Lịch học</h5>
                <div id="editScheduleContainer"></div>
                <button type="button" class="btn btn-outline-primary btn-sm mt-3" onclick="addScheduleRow('edit')"><i class="fas fa-plus me-2"></i> Thêm Lịch</button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-warning" onclick="updateClass()">Lưu Thay Đổi</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="studentProfileModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fa-solid fa-user-graduate me-2"></i> Hồ Sơ Học Viên</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="d-flex align-items-center mb-4">
                    <img id="profileAvatar" src="" alt="Avatar" class="rounded-circle me-3" style="width: 80px; height: 80px; object-fit: cover;">
                    <div>
                        <h4 class="mb-0 fw-bold" id="profileFullName">...</h4>
                        <p class="text-muted mb-0" id="profileUsername">...</p>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong><i class="fa-solid fa-envelope me-2"></i> Email:</strong> <span id="profileEmail"></span></p>
                        <p><strong><i class="fa-solid fa-phone me-2"></i> Điện thoại:</strong> <span id="profilePhone"></span></p>
                        <p><strong><i class="fa-solid fa-location-dot me-2"></i> Khu vực:</strong> <span id="profileLocation"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong><i class="fa-solid fa-star me-2"></i> Môn học ưu tiên:</strong> <span id="profileSubjects"></span></p>
                        <p><strong><i class="fa-solid fa-money-bill-wave me-2"></i> Ngân sách:</strong> <span id="profileBudget"></span></p>
                    </div>
                </div>
                <h6 class="fw-bold mt-4 text-primary">Tiểu sử (Bio)</h6>
                <p id="profileBio" class="alert alert-light border-0"></p>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    const API_BASE = "http://localhost:8080/api";
    
    // --- FIX 1: Hardcode ID Tutor (Giống file HomeTutor.html) ---
    const CURRENT_TUTOR_ID = 5; 
    let classId = null;
    let classData = null; 

    document.addEventListener("DOMContentLoaded", () => {
        // Lấy ID lớp từ URL (detail_class.html?id=1)
        const urlParams = new URLSearchParams(window.location.search);
        classId = urlParams.get('id');

        if (!classId) {
            Swal.fire("Lỗi", "Không tìm thấy ID lớp học.", "error").then(() => {
                window.location.href = 'HomeTutor.html';
            });
            return;
        }

        loadClassDetail();
        loadBookings(); 
    });

    // --- 1. Tải thông tin lớp học ---
    async function loadClassDetail() {
        try {
            const res = await fetch(`${API_BASE}/classes/${classId}`);
            const json = await res.json();
            
            if(json.success) {
                classData = json.data;
                renderClassInfo(classData);
                setupEditModal(classData);
            } else {
                throw new Error(json.message);
            }
        } catch (e) {
            Swal.fire("Lỗi", "Không thể tải thông tin lớp học.", "error");
        }
    }

    function renderClassInfo(data) {
        document.getElementById('classSubject').textContent = data.subject;
        document.getElementById('classTutorName').textContent = `Gia sư: ${data.tutorName}`;
        document.getElementById('classStatus').textContent = data.status === 'ACTIVE' ? 'Đang hoạt động' : 'Đã đóng';
        document.getElementById('classFee').textContent = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(data.fee);
        document.getElementById('classDescription').textContent = data.description || 'Chưa có mô tả.';
        document.getElementById('classLocation').textContent = data.location || 'Chưa cập nhật.';
        document.getElementById('classMaxStudents').textContent = data.maxStudents;
        document.getElementById('classCurrentStudents').textContent = data.currentStudents;
        document.getElementById('classCreatedAt').textContent = new Date(data.createdAt).toLocaleDateString('vi-VN');

        const scheduleList = document.getElementById('scheduleList');
        scheduleList.innerHTML = '';
        if (data.schedules && data.schedules.length > 0) {
            data.schedules.forEach(s => {
                const tag = document.createElement('span');
                tag.className = 'schedule-tag';
                // Xử lý format time
                let start = Array.isArray(s.startTime) ? s.startTime[0]+':'+s.startTime[1].toString().padStart(2,'0') : s.startTime.substring(0,5);
                let end = Array.isArray(s.endTime) ? s.endTime[0]+':'+s.endTime[1].toString().padStart(2,'0') : s.endTime.substring(0,5);
                tag.textContent = `${s.dayOfWeek} (${start} - ${end})`;
                scheduleList.appendChild(tag);
            });
        } else {
            scheduleList.innerHTML = '<p class="text-muted">Chưa có lịch học.</p>';
        }
    }

    // --- 2. Tải danh sách Booking (FIX QUAN TRỌNG) ---
    async function loadBookings() {
        const tbody = document.getElementById("studentListBody");
        try {
            // FIX: Backend không có API get bookings theo classId trực tiếp.
            // Giải pháp: Gọi API lấy tất cả booking của Tutor, sau đó lọc theo classId
            const res = await fetch(`${API_BASE}/bookings/tutor/${CURRENT_TUTOR_ID}`);
            const json = await res.json();
            
            if(json.success) {
                const allBookings = json.data || [];
                // LỌC Ở ĐÂY: Chỉ lấy booking của lớp hiện tại
                const classBookings = allBookings.filter(b => b.classId == classId);
                
                renderStudentList(classBookings);
            } else {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">${json.message}</td></tr>`;
            }
        } catch (e) {
            console.error(e);
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Lỗi kết nối server.</td></tr>';
        }
    }

    function renderStudentList(bookings) {
        const tbody = document.getElementById("studentListBody");
        if (bookings.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3">Chưa có học viên nào đăng ký lớp này.</td></tr>';
            return;
        }

        const html = bookings.map(b => {
            let badgeClass = 'bg-secondary';
            let statusText = b.status;
            
            if(b.status === 'CONFIRMED') { badgeClass = 'bg-success'; statusText = 'Đã xác nhận'; }
            else if(b.status === 'PENDING') { badgeClass = 'bg-warning text-dark'; statusText = 'Chờ duyệt'; }
            else if(b.status === 'CANCELLED') { badgeClass = 'bg-danger'; statusText = 'Đã hủy'; }

            return `
                <tr class="clickable-row" onclick="showStudentProfile(${b.studentId})" title="Xem hồ sơ học viên">
                    <td>#${b.studentId}</td>
                    <td class="fw-bold text-primary">${b.studentName}</td>
                    <td>${new Date(b.bookedDate).toLocaleDateString('vi-VN')}</td>
                    <td><span class="badge ${badgeClass}">${statusText}</span></td>
                </tr>
            `;
        }).join('');
        tbody.innerHTML = html;
    }

    // --- 3. Chỉnh sửa lớp (Edit) ---
    function setupEditModal(data) {
        document.getElementById("editClassId").value = data.id;
        document.getElementById("editSubject").value = data.subject;
        document.getElementById("editFee").value = data.fee;
        document.getElementById("editMax").value = data.maxStudents;
        document.getElementById("editLocation").value = data.location;
        document.getElementById("editDesc").value = data.description;
        
        const container = document.getElementById("editScheduleContainer");
        container.innerHTML = '';
        if (data.schedules && data.schedules.length > 0) {
            data.schedules.forEach(s => {
                // Xử lý time format cho input type="time"
                let start = Array.isArray(s.startTime) ? s.startTime[0].toString().padStart(2,'0')+':'+s.startTime[1].toString().padStart(2,'0') : s.startTime.substring(0,5);
                let end = Array.isArray(s.endTime) ? s.endTime[0].toString().padStart(2,'0')+':'+s.endTime[1].toString().padStart(2,'0') : s.endTime.substring(0,5);
                addScheduleRow('edit', s.dayOfWeek, start, end);
            });
        } else {
            addScheduleRow('edit');
        }
    }
    
    function addScheduleRow(prefix, day = '', start = '', end = '') {
        const container = document.getElementById(prefix + 'ScheduleContainer');
        const row = document.createElement('div');
        row.className = 'row g-3 mb-2 schedule-row align-items-center';
        row.innerHTML = `
            <div class="col-4">
                <select class="form-select inp-day" required>
                    <option value="" disabled selected>Chọn Thứ</option>
                    <option value="MONDAY" ${day === 'MONDAY' ? 'selected' : ''}>Thứ 2</option>
                    <option value="TUESDAY" ${day === 'TUESDAY' ? 'selected' : ''}>Thứ 3</option>
                    <option value="WEDNESDAY" ${day === 'WEDNESDAY' ? 'selected' : ''}>Thứ 4</option>
                    <option value="THURSDAY" ${day === 'THURSDAY' ? 'selected' : ''}>Thứ 5</option>
                    <option value="FRIDAY" ${day === 'FRIDAY' ? 'selected' : ''}>Thứ 6</option>
                    <option value="SATURDAY" ${day === 'SATURDAY' ? 'selected' : ''}>Thứ 7</option>
                    <option value="SUNDAY" ${day === 'SUNDAY' ? 'selected' : ''}>CN</option>
                </select>
            </div>
            <div class="col-3"><input type="time" class="form-control inp-start" value="${start}" required></div>
            <div class="col-3"><input type="time" class="form-control inp-end" value="${end}" required></div>
            <div class="col-2 text-end"><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('.schedule-row').remove()"><i class="fas fa-times"></i></button></div>
        `;
        container.appendChild(row);
    }
    
    async function updateClass() {
        const editModal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
        const id = document.getElementById("editClassId").value;
        const subject = document.getElementById("editSubject").value;
        const fee = document.getElementById("editFee").value;
        const max = document.getElementById("editMax").value;
        const loc = document.getElementById("editLocation").value;
        const desc = document.getElementById("editDesc").value;
        
        const schedules = [];
        document.querySelectorAll("#editScheduleContainer .schedule-row").forEach(r => {
             const day = r.querySelector(".inp-day").value;
             const start = r.querySelector(".inp-start").value;
             const end = r.querySelector(".inp-end").value;
             if(day && start && end) {
                 schedules.push({ dayOfWeek: day, startTime: start, endTime: end, location: loc });
             }
        });

        try {
            const res = await fetch(`${API_BASE}/classes/${id}/tutor/${CURRENT_TUTOR_ID}`, {
                method: "PUT", 
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    subject, description: desc, fee: parseFloat(fee), 
                    maxStudents: parseInt(max), location: loc, schedules 
                }),
            });
            const json = await res.json();
            
            if(json.success) {
                editModal.hide();
                Swal.fire("Thành công", "Đã cập nhật", "success");
                loadClassDetail(); 
            } else {
                Swal.fire("Lỗi", json.message || "Không thể cập nhật", "error");
            }
        } catch (e) { Swal.fire("Lỗi", "Không thể kết nối đến server", "error"); }
    }
    
    // --- 4. Xóa lớp ---
    function deleteClass() {
        Swal.fire({
            title: 'Xóa lớp học?',
            text: "Hành động này không thể hoàn tác!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'Xóa ngay',
            cancelButtonText: 'Hủy'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    const res = await fetch(`${API_BASE}/classes/${classId}/tutor/${CURRENT_TUTOR_ID}`, { method: "DELETE" });
                    if(res.ok) {
                        Swal.fire('Đã xóa!', 'Lớp học đã được xóa.', 'success').then(() => window.location.href = 'HomeTutor.html');
                    } else {
                        Swal.fire("Lỗi", "Không thể xóa lớp học.", "error");
                    }
                } catch (e) { Swal.fire("Lỗi", "Lỗi kết nối.", "error"); }
            }
        });
    }

    // --- 5. Xem hồ sơ học viên ---
    const studentProfileModal = new bootstrap.Modal(document.getElementById('studentProfileModal'));

    async function showStudentProfile(studentId) {
        try {
            const res = await fetch(`${API_BASE}/students/${studentId}/profile`);
            const json = await res.json();

            if (json.success) {
                const p = json.data;
                const u = p.user || {}; 

                document.getElementById('profileAvatar').src = p.avatar || 'https://via.placeholder.com/80?text=Student';
                document.getElementById('profileFullName').textContent = u.fullName || 'Học viên #' + studentId;
                document.getElementById('profileUsername').textContent = `@${u.username || 'unknown'}`;
                document.getElementById('profileEmail').textContent = u.email || 'N/A';
                document.getElementById('profilePhone').textContent = u.phone || 'N/A';
                document.getElementById('profileLocation').textContent = p.location || 'Chưa cập nhật';
                document.getElementById('profileSubjects').textContent = p.preferenceSubjects || '---';
                
                let budget = 'Chưa cập nhật';
                if(p.budgetMin && p.budgetMax) {
                    budget = new Intl.NumberFormat('vi-VN').format(p.budgetMin) + ' - ' + new Intl.NumberFormat('vi-VN').format(p.budgetMax);
                }
                document.getElementById('profileBudget').textContent = budget;
                document.getElementById('profileBio').textContent = p.bio || 'Chưa có tiểu sử.';

                studentProfileModal.show();
            } else {
                Swal.fire("Lỗi", "Không tìm thấy hồ sơ học viên.", "error");
            }
        } catch (e) {
            Swal.fire("Lỗi", "Lỗi tải hồ sơ.", "error");
        }
    }
</script>
</body>
</html>